---
layout: post
title: 上传漏洞知识总结
categories: [经验总结]
tags: [Upload]
fullview: false
comments: true
---
这两天换电脑，收拾了自己之前写的一些笔记，忽然发现自己之前没有好好保存之前的笔记数据真的是个大错误。
这里是自己整理的一些关于上传漏洞的知识点。

# 上传漏洞 

上传漏洞是在正常的客户端和服务端上传文件过程的基础上产生的。

>通常一个文件以 HTTP 协议进行上传时，将以 POST 请求发送至 web 服务器 web 服务器接收到请求后并同意后，用户与 web 服务器将建立连接，并传输 data

在这个过程中，如果没有对文件名等信息进行检测就会产生上传漏洞。

下面说下常见的文件上传检测，以及常见的绕过方式。

# 文件上传的检测和绕过

通常，针对上传文件的检测有两种：客户端检测、服务端检测。在安全性上，服务端检测安全性更高。

## 客户端检测与绕过方法

这里说的客户端通常指浏览器，当然也可能是其他平台的应用，如安卓，苹果等。

这里用浏览器端举例，来使用这种检测方式的 WEB 应用已经不是很多了。

在浏览器进行客户端检测使用JavaScript，由于JavaScript直接在页面上执行，文件上传之前就会有相应，一般遇见这种情况就可以判断是前端验证了。

现在市面上的浏览器大都支持查看修改网页源码的功能，这样就可以通过修改、删除JavaScript代码，轻松绕过前端的JavaScript检测。

或者使用Burpsuite等工具代理，绕过浏览器的过滤。

如果有还在使用这种检测方法的网站或者有使用JavaScript校验文件的开发者，强烈建议打消念头，这种检测方式形同虚设，bypass成本太低。

## 服务端检测与绕过方法

服务端对上传文件进行检测的方法有：

* MIME检测
* 目录路径检测
* 文件扩展名检测
* 文件内容检测

### MIME检测与绕过

> 多用途互联网邮件扩展（MIME，Multipurpose Internet Mail Extensions）是一个互联网标准，它扩展了电子邮件标准，使其能够支援：非ASCII字符文本；
  非文本格式附件（二进制、声音、图像等）；由多部分（multiple parts）组成的消息体；包含非ASCII字符的头信息（Header information）。
  这个标准被定义在RFC 2045、RFC 2046、RFC 2047、RFC 2048、RFC 2049等RFC中。

简单地说，MIME就是区分多媒体文件的一种标准。其中经常见得就是在HTTP请求中夹带的Content-Type(内容类型)，在这里重点说的也就是它。

如果尝试上传一个asp木马，服务器会收到一个含有Content-Type:application/octet-stream的请求，当服务器发现了这个文件类型并不安全时，就会拒绝文件上传。

如果服务端仅仅检测MIME类型的话很容易就会被bypass。

通过Burpsuite等工具抓包，修改Content-type为服务器允许的类型如:image/gif 进行绕过。

也有服务端会同时检查文件流的长度，也就是Content-length，如果上传文件的大小和这个值对不上，服务器也会拒绝文件上传。

所以在绕过的过程中，如果出现了Content-length时不要忘了修改文件大小。
